(function () { 

    // load modules {{{
    var fs = require('fs'),
        populateTemplate = require('./theosp-nodejs-template-engine/template_engine').populateTemplate;
    // }}}

    // options {{{
    var options = {
        conf_file: 'project.conf',
        project_path: undefined
    };
    // }}}

    // variables {{{
    var templates = {

        // standard {{{
        standard: {
            "./api-generator-templates/standard/api.py":
                "apis/{{ underscored_entity_name }}.py",
            "./api-generator-templates/standard/api.js":
                "javascript/src/apis/{{ underscored_entity_name }}.js",
            "./api-generator-templates/standard/admin_frontend_section.js":
                "javascript/src/frontends/admin/{{ underscored_pluralized_entity_name }}_section.js",
            "./api-generator-templates/standard/admin_frontend_editor.js":
                "javascript/src/frontends/admin/{{ underscored_pluralized_entity_name }}_editor.js",
            "./api-generator-templates/standard/model.py":
                "apis/models/{{ underscored_entity_name }}.py"
        },
        // }}}

        // file_system {{{
        file_system: {
            "./api-generator-templates/file_system/api.py":
                "apis/{{ underscored_entity_name }}.py",
            "./api-generator-templates/file_system/api.js":
                "javascript/src/apis/{{ underscored_entity_name }}.js",
            "./api-generator-templates/file_system/admin_frontend_section.js":
                "javascript/src/frontends/admin/{{ underscored_pluralized_entity_name }}_section.js",
            "./api-generator-templates/file_system/admin_frontend_uploader.js":
                "javascript/src/frontends/admin/{{ underscored_pluralized_entity_name }}_uploader.js",
            "./api-generator-templates/file_system/model.py":
                "apis/models/{{ underscored_entity_name }}.py"
        }
        // }}}

    };
    // }}}

    // actions {{{
    var actions = {

        // help {{{
        help: function () {
            process.stdout.write([
                "NAME",
                "    theosp-gae-api-generator - Genrate a new api for Google App Engine application along with its admin interfaces",
                "    ",
                "    SYNOPSIS",
                "        ./theosp-gae-api-generator [--conf=<theosp-gae-api-generator-conf-file>] [--project-path=<appengine-project-path>] install [<api-key>]",
                "        ./theosp-gae-api-generator [-h] [--help]",
                "   ",
                "    OPTIONS",
                "        --conf=<theosp-gae-api-generator-conf-file>",
                "            If specified will be used instead of the default project.conf",
                "",
                "        --project-path=<appengine-project-path>",
                "            If specified will be used instead of the project object's project_path property which available in the conf file",
                "",
                "    COMMANDS",
                "        install",
                "            install all the apis defined in the config file unless specific <api-key> is given.",
                ""
            ].join("\n"));
        },
        // }}}

        // install {{{
        install: function (api_to_install) {
            var apis;

            // if the specific api picked
            if (typeof api_to_install !== 'undefined') {
                apis = [project.apis[api_to_install]];
            } else {
                apis = project.apis; // install all by default
            }

            for (var api_key in apis) {
                if (apis.hasOwnProperty(api_key)) {
                    var api = apis[api_key];

                    if (typeof api.type === 'undefined') {
                        api.type = "standard";
                    }

                    (function (api) {
                        // generate api's templates components {{{
                        var templates_components = {

                            // Tags {{{
                            tags: {

                                // project_domain {{{
                                project_domain: project.domain,
                                // }}}

                                // readable_capitalized_entity_name: {{{
                                readable_capitalized_entity_name: api.entity_name,
                                // }}}

                                // readable_capitalized_pluralized_entity_name {{{
                                readable_capitalized_pluralized_entity_name: api.pluralized_entity_name,
                                // }}}

                                // readable_noncapitalized_entity_name {{{
                                readable_noncapitalized_entity_name: api.entity_name.toLowerCase(),
                                // }}}

                                // readable_noncapitalized_pluralized_entity_name {{{
                                readable_noncapitalized_pluralized_entity_name: api.pluralized_entity_name.toLowerCase(),
                                // }}}

                                // underscored_entity_name {{{
                                underscored_entity_name: api.entity_name.toLowerCase().replace(/ /g, '_'),
                                // }}}

                                // underscored_pluralized_entity_name {{{
                                underscored_pluralized_entity_name: api.pluralized_entity_name.toLowerCase().replace(/ /g, '_'),
                                // }}}

                                // camelcased_entity_name {{{
                                camelcased_entity_name: api.entity_name.replace(/ /g, ''),
                                // }}}

                                // camelcased_pluralized_entity_name {{{
                                camelcased_pluralized_entity_name: api.pluralized_entity_name.replace(/ /g, ''),
                                // }}}

                                // lower_camelcased_pluralized_entity_name {{{
                                lower_camelcased_pluralized_entity_name: function () {
                                    var s = api.pluralized_entity_name.replace(/ /g, '');

                                    return s.charAt(0).toLowerCase() + s.substr(1);
                                },
                                // }}}

                                // admin_section_table_cols_count {{{
                                admin_section_table_cols_count: function () {
                                    // If images preview
                                    if (typeof api.images_preview !== 'undefined' && api.images_preview === true) {
                                        return 7;
                                    }

                                    return 6;
                                }
                                // }}}
                            },
                            // }}}

                            // Conditional sections {{{
                            conditional_sections: {
                                show_images_preview: (typeof api.images_preview !== 'undefined' && api.images_preview === true) ? true : false,
                                mime_types_restriced: (typeof api.mime_types_restriced !== 'undefined' && api.mime_types_restriced === true) ? true : false
                            },
                            // }}}

                            // iterators {{{
                            iterators: {
                                allowed_mime_types: (typeof api.allowed_mime_types !== "undefined") ? api.allowed_mime_types : [],
                                properties: (typeof api.properties !== "undefined") ? api.properties : []
                            }
                            // }}}
                            
                        };
                        // }}}

                        // copy templates files to their path in the project {{{
                        for (var template_path in templates[api.type]) {
                            if (templates[api.type].hasOwnProperty(template_path)) {
                                var output_path = options.project_path + '/' +
                                        populateTemplate(templates[api.type][template_path], templates_components),
                                    read_stream = fs.createReadStream(template_path, {encoding: 'utf8'}),
                                    write_stream = fs.createWriteStream(output_path);

                                // without a the anon func the callback for
                                // write_stream.once might hold the next for loop
                                // iteration read/write_streams
                                (function (read_stream, write_stream) {
                                    var template = '';
                                    read_stream
                                        .on('data', function (data) {
                                            template += data;
                                        })
                                        .on('end', function () {
                                            write_stream.write(
                                                populateTemplate(template, templates_components));
                                        });
                                })(read_stream, write_stream);
                            }
                        }
                        // }}}

                        var read_stream = fs.createReadStream('./api-generator-templates/' + api.type + '/tasks.txt', {encoding: 'utf8'}),
                            tasks = '';

                        read_stream
                            .on('data', function (data) {
                                tasks += data;
                            })
                            .on('end', function () {
                                console.log(populateTemplate(tasks, templates_components));
                            });
                    })(api);
                }
            }
        }
        // }}}

    };
    // }}}

    // getOpts {{{
    var getOpts = function (argv) {
            argv = argv.slice(2); // remove the call for node and the script name

            var action,
                action_args = [];

            // options {{{
            for (var i = 0; i < argv.length; i++) {
                var arg = argv[i];
            
                if (/^--conf=.+/.test(arg)) {
                    options.conf_file = arg.replace('--conf=', "");
                } else if (/^--project-path=.+/.test(arg)) {
                    options.project_path = arg.replace('--project-path=', "");
                } else if (/^--/.test(arg)) {
                    console.log("Error: Unkown option: " + arg.replace(/\=.*/, '') + "\n");
                    actions.help();

                    process.exit();
                } else {
                    // remove the options arguments from argv and exit
                    argv = argv.slice(i); 
                    break;
                }
            }
            // }}}

            // action {{{
            if (typeof argv[0] !== 'undefined') {
                action = argv[0];

                if (!(action in actions)) {
                    console.log("Error: Unknown action " + action + "." + "\n");

                    action = "help";
                }
            } else {
                console.log("Error: No action found" + "\n");

                action = "help";
            }
            // }}}

            // action_args {{{
            action_args = argv.slice(1);
            // }}}

            return {action: action, args: action_args};
        };
    // }}}

    // main {{{
    var main = function () {
        var opts = getOpts(process.argv);

        // if action isn't help {{{
        if (opts.action != "help") {
            // normalize conf_file option {{{
            if (options.conf_file.indexOf('/') === -1) {
                options.conf_file = './' + options.conf_file;
            }
            // }}}

            // load project conf {{{
            project = require(options.conf_file).project;
            // }}}

            // if project has project_path and the user didn't explicitly set project path using command line argument option {{{
            if (typeof project.project_path !== 'undefined' && typeof options.project_path === 'undefined') {
                options.project_path = project.project_path;
            }
            // }}}

            if (typeof options.project_path === 'undefined') {
                console.log("Error: you must set your project-path either in the conf file (project_path property)");
                console.log("or by passing it as a command line argument --project-path=<project-path>\n");

                // show help and exit
                actions.help();
                process.exit();
            }

            // normalize conf_file option {{{
            if (options.project_path.slice(-1) === "/") {
                options.project_path = options.project_path.slice(0, -1);
            }
            // }}}
        }
        // }}}

        actions[opts.action].apply(this, opts.args);
    };
    // }}}

    // if main {{{
    if (!module.parent) {
        main();
    }
    // }}}

})();

// vim:ft=javascript:fdm=marker:fmr={{{,}}}:
